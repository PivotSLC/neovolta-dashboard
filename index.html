<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neovolta ‚Äî Quarterly Invoice Trends</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1117;
  --surface: #181a23;
  --surface-hover: #1e2130;
  --border: #2a2d3a;
  --text: #e8e9ed;
  --text-muted: #8b8fa3;
  --text-dim: #5c6078;
  --green: #34d399;
  --red: #f87171;
  --amber: #fbbf24;
  --blue: #60a5fa;
  --purple: #a78bfa;
  --q3: #60a5fa;
  --q4: #a78bfa;
  --q1: #34d399;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; padding:32px; }
.loading { display:flex; align-items:center; justify-content:center; min-height:100vh; flex-direction:column; gap:8px; }
.loading h2 { font-size:18px; }
.loading p { font-size:12px; color:var(--text-muted); }

.header { margin-bottom:28px; }
.header-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
.logo { font-size:10px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); }
.date-badge { font-size:11px; color:var(--text); background:var(--surface); border:1px solid var(--border); padding:5px 12px; border-radius:4px; font-family:'JetBrains Mono',monospace; font-weight:700; }
.date-badge .dot { color:var(--green); margin-right:6px; }
h1 { font-size:24px; font-weight:700; letter-spacing:-0.5px; }
.subtitle { font-size:13px; color:var(--text-muted); margin-top:4px; }

.scorecards { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px; }
.scorecards-left { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.scorecard { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:20px 24px; }
.scorecard.alert { border-color:rgba(248,113,113,0.25); background:rgba(248,113,113,0.08); }
.scorecard.alert .sc-val { color:var(--red); }
.scorecard.good { border-color:rgba(52,211,153,0.25); background:rgba(52,211,153,0.08); }
.scorecard.good .sc-val { color:var(--green); }
.scorecard.amber { border-color:rgba(251,191,36,0.25); background:rgba(251,191,36,0.08); }
.scorecard.amber .sc-val { color:var(--amber); }
.sc-label { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--text-dim); margin-bottom:8px; }
.sc-val { font-size:26px; font-weight:700; letter-spacing:-0.5px; font-family:'JetBrains Mono',monospace; }
.sc-sub { font-size:12px; color:var(--text-muted); margin-top:4px; }

.chart-box { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:24px; }
.chart-title { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--text-dim); margin-bottom:16px; }
.chart-bars { display:flex; align-items:flex-end; gap:16px; height:160px; margin-bottom:8px; }
.chart-bar-col { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; }
.chart-bar-inner { flex:1; width:100%; display:flex; flex-direction:column; justify-content:flex-end; }
.chart-bar-val { font-size:14px; font-weight:700; color:var(--text); text-align:center; margin-bottom:6px; font-family:'JetBrains Mono',monospace; }
.chart-bar { width:100%; border-radius:8px 8px 0 0; transition:height 0.6s ease; }
.chart-labels { display:flex; gap:16px; }
.chart-labels span { flex:1; text-align:center; font-size:11px; font-weight:600; color:var(--text-muted); }

/* AI Insights */
.insights-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; margin-bottom:24px; overflow:hidden; }
.insights-header { display:flex; justify-content:space-between; align-items:center; padding:16px 24px; cursor:pointer; user-select:none; }
.insights-header:hover { background:var(--surface-hover); }
.insights-title { display:flex; align-items:center; gap:10px; }
.insights-title .icon { width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, rgba(167,139,250,0.2), rgba(96,165,250,0.2)); display:flex; align-items:center; justify-content:center; font-size:14px; }
.insights-title h3 { font-size:13px; font-weight:700; letter-spacing:-0.2px; }
.insights-title .powered { font-size:10px; color:var(--text-dim); font-weight:500; }
.insights-toggle { font-size:18px; color:var(--text-dim); transition:transform 0.3s; }
.insights-toggle.open { transform:rotate(180deg); }
.insights-body { padding:0 24px 20px; display:none; }
.insights-body.open { display:block; }
.insights-loading { display:flex; align-items:center; gap:10px; padding:16px 0; color:var(--text-muted); font-size:13px; }
.insights-loading .spinner { width:16px; height:16px; border:2px solid var(--border); border-top:2px solid var(--purple); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
.insights-error { color:var(--red); font-size:12px; padding:8px 0; }
.insight-list { list-style:none; display:flex; flex-direction:column; gap:12px; }
.insight-item { display:flex; gap:12px; align-items:flex-start; padding:12px 16px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.04); }
.insight-icon { width:24px; height:24px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; margin-top:1px; }
.insight-icon.risk { background:rgba(248,113,113,0.15); }
.insight-icon.opp { background:rgba(52,211,153,0.15); }
.insight-icon.trend { background:rgba(96,165,250,0.15); }
.insight-icon.watch { background:rgba(251,191,36,0.15); }
.insight-icon.info { background:rgba(167,139,250,0.15); }
.insight-text { font-size:13px; line-height:1.5; color:var(--text-muted); }
.insight-text strong { color:var(--text); font-weight:600; }
.insights-refresh { display:inline-flex; align-items:center; gap:6px; margin-top:12px; background:transparent; border:1px solid var(--border); color:var(--text-dim); padding:5px 12px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.15s; }
.insights-refresh:hover { border-color:rgba(255,255,255,0.2); color:var(--text-muted); }

.filters-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:8px; }
.filter-group { display:flex; gap:6px; align-items:center; }
.filter-label { font-size:10px; color:var(--text-dim); font-weight:600; margin-right:2px; }
.btn { background:transparent; border:1px solid var(--border); color:var(--text-muted); padding:5px 12px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.15s; }
.btn:hover { border-color:rgba(255,255,255,0.2); }
.btn.active { background:rgba(255,255,255,0.1); border-color:rgba(255,255,255,0.2); color:var(--text); }
.btn.type-active { background:rgba(96,165,250,0.15); border-color:rgba(96,165,250,0.4); color:var(--blue); }
.btn-sm { padding:4px 10px; border-radius:4px; font-size:10px; }

.main-grid { display:grid; grid-template-columns:1fr 380px; gap:16px; align-items:start; }
.cards-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

.card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:16px; cursor:pointer; transition:all 0.2s; border-left:3px solid var(--text-dim); }
.card:hover { background:var(--surface-hover); }
.card.selected { background:var(--surface-hover); }
.card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; }
.card-name { font-size:13px; font-weight:700; max-width:55%; }
.card-type { font-size:9px; font-weight:600; letter-spacing:0.5px; text-transform:uppercase; color:var(--text-dim); margin-top:2px; }
.card-type.dist { color:var(--blue); }
.card-footer { display:flex; justify-content:space-between; align-items:center; margin-top:10px; font-size:10px; color:var(--text-muted); }
.card-deal { color:var(--amber); font-weight:600; }

.badge { display:inline-flex; align-items:center; gap:4px; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600; font-family:'JetBrains Mono',monospace; white-space:nowrap; }
.badge .bdot { width:6px; height:6px; border-radius:50%; display:inline-block; }
.badge.danger { background:rgba(248,113,113,0.1); color:var(--red); border:1px solid rgba(248,113,113,0.25); }
.badge.expected { background:rgba(251,191,36,0.1); color:var(--amber); border:1px solid rgba(251,191,36,0.25); }
.badge.healthy { background:rgba(52,211,153,0.1); color:var(--green); border:1px solid rgba(52,211,153,0.25); }

.mini-bars { display:flex; flex-direction:column; gap:2px; }
.mini-row { display:flex; align-items:center; gap:6px; height:16px; }
.mini-label { font-size:9px; color:var(--text-dim); width:18px; text-align:right; font-weight:600; }
.mini-track { flex:1; height:12px; background:rgba(255,255,255,0.04); border-radius:3px; overflow:hidden; }
.mini-fill { height:100%; border-radius:3px; transition:width 0.6s ease; }
.mini-val { font-size:10px; font-family:'JetBrains Mono',monospace; width:55px; text-align:right; }

.detail { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:24px; position:sticky; top:32px; }
.detail.empty { padding:40px; text-align:center; color:var(--text-dim); font-size:13px; }
.detail-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.detail-name { font-size:18px; font-weight:700; }
.detail-sub { font-size:12px; color:var(--text-muted); margin-top:2px; }
.detail-sub .dtype { font-weight:600; }
.detail-sub .dtype.dist { color:var(--blue); }

.detail-chart { display:flex; align-items:flex-end; gap:12px; height:140px; margin-bottom:8px; padding:0 20px; }
.detail-bar-col { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; }
.detail-bar-inner { flex:1; width:100%; display:flex; flex-direction:column; justify-content:flex-end; }
.detail-bar-val { font-size:11px; font-weight:600; text-align:center; margin-bottom:4px; font-family:'JetBrains Mono',monospace; }
.detail-bar { width:100%; border-radius:6px 6px 0 0; transition:height 0.5s ease; }
.detail-labels { display:flex; gap:12px; padding:0 20px; margin-bottom:20px; }
.detail-labels span { flex:1; text-align:center; font-size:10px; font-weight:600; color:var(--text-muted); }

.trend-row { display:flex; gap:12px; margin-bottom:16px; }
.trend-box { flex:1; background:rgba(255,255,255,0.03); border-radius:8px; padding:12px; text-align:center; }
.trend-label { font-size:10px; color:var(--text-dim); margin-bottom:4px; font-weight:600; }
.trend-val { font-size:16px; font-weight:700; font-family:'JetBrains Mono',monospace; }

.deal-box { background:rgba(255,255,255,0.03); border-radius:8px; padding:12px; }
.deal-title { font-size:10px; color:var(--text-dim); font-weight:600; margin-bottom:6px; }
.deal-row { display:flex; justify-content:space-between; font-size:12px; }
.deal-row span { color:var(--text-muted); }
.deal-row strong { color:var(--text); font-weight:600; }
.deal-row .amt { color:var(--amber); font-weight:700; }

.footer { text-align:center; padding:24px 0 8px; font-size:10px; color:var(--text-dim); }
.footer a { color:var(--text-muted); text-decoration:underline; }

@media(max-width:1100px) {
  .main-grid { grid-template-columns:1fr; }
  .detail { position:static; }
}
@media(max-width:900px) {
  body { padding:16px; }
  .scorecards { grid-template-columns:1fr; }
  .cards-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<div id="app" class="loading">
  <h2>Loading dashboard...</h2>
  <p>Fetching data from Google Sheets</p>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIiOf5lYvr2kIR6aBr1ASJvEQBc-L6lMTUsx5iqznCSkh0Jlr3FOdJNt_DIPvlTpV0es1OdFBZ82V2/pub?gid=0&single=true&output=csv";

// ‚ö° CHANGE THIS to your Cloudflare Worker URL after deploying
const WORKER_URL = "https://neovolta-insights.jane-johnson.workers.dev/";

let STATE = {
  data: [],
  filtered: [],
  selected: null,
  filter: "all",
  typeFilter: "all",
  sortBy: "risk",
  lastUpdated: "",
  insightsOpen: true,
  insightsHTML: null,
  insightsLoading: false,
  insightsError: null,
};

function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = [];
  let hLine = lines[0];
  let cur = "", inQ = false;
  for (let i = 0; i < hLine.length; i++) {
    if (hLine[i] === '"') inQ = !inQ;
    else if (hLine[i] === ',' && !inQ) { headers.push(cur.trim()); cur = ""; }
    else cur += hLine[i];
  }
  headers.push(cur.trim());

  return lines.slice(1).map(line => {
    const vals = [];
    let c = "", q = false;
    for (let i = 0; i < line.length; i++) {
      if (line[i] === '"') q = !q;
      else if (line[i] === ',' && !q) { vals.push(c.trim()); c = ""; }
      else c += line[i];
    }
    vals.push(c.trim());
    const row = {};
    headers.forEach((h, i) => row[h] = vals[i] || "");
    return row;
  });
}

function parseDate(val) {
  if (!val) return null;
  const num = Number(val);
  if (num > 1000000000000) { return new Date(num).toISOString().split("T")[0]; }
  if (num > 1000000000) { return new Date(num * 1000).toISOString().split("T")[0]; }
  if (val.includes("-") || val.includes("/")) return val.split(" ")[0];
  return null;
}

function parseSheetData(rows) {
  return rows.map(r => ({
    id: r["Record ID"] || "",
    company: r["Company Name"] || "",
    type: (r["Company Type"] || "Installer").trim(),
    q3: parseFloat(r["Invoiced Q3 2025"]) || 0,
    q4: parseFloat(r["Invoiced Q4 2025"]) || 0,
    q1: parseFloat(r["Invoiced Q1 2026"]) || 0,
    dealAmt: parseFloat(r["Recent Deal Amount"]) || 0,
    lastClose: parseDate(r["Recent Deal Close Date"]),
    openDeals: parseInt(r["Number of Open Deals"]) || 0,
  })).filter(r => r.company);
}

function getSignal(d) {
  const isDeclining = d.q1 < d.q4 || (d.q1 === 0 && d.q4 === 0 && d.q3 > 0);
  const hasRecentClose = d.lastClose && new Date(d.lastClose) >= new Date("2026-01-01");
  if (!isDeclining) return { type: "healthy", label: "Healthy", color: "#34d399" };
  if (d.dealAmt > 0) return { type: "expected", label: "~" + fmt(d.dealAmt) + " expected", color: "#fbbf24" };
  if (hasRecentClose) return { type: "expected", label: "Invoice expected", color: "#fbbf24" };
  return { type: "danger", label: "No deal activity", color: "#f87171" };
}

function fmt(v) {
  if (v === 0) return "$0";
  if (v >= 1000000) return "$" + (v/1000000).toFixed(1) + "M";
  if (v >= 1000) return "$" + (v/1000).toFixed(0) + "K";
  return "$" + v.toLocaleString();
}
function fmtFull(v) { return "$" + v.toLocaleString("en-US", {maximumFractionDigits:0}); }
function fmtDate(d) {
  if (!d) return "‚Äî";
  return new Date(d + "T00:00:00").toLocaleDateString("en-US", {month:"short",day:"numeric"});
}

// ===== AI INSIGHTS =====

function buildInsightsPrompt(data) {
  const filtered = data.filter(r => r.q3 + r.q4 + r.q1 >= 1000);
  const tQ3 = filtered.reduce((s,d)=>s+d.q3,0);
  const tQ4 = filtered.reduce((s,d)=>s+d.q4,0);
  const tQ1 = filtered.reduce((s,d)=>s+d.q1,0);
  const atRisk = filtered.filter(d => getSignal(d).type === "danger");
  const expected = filtered.filter(d => getSignal(d).type === "expected");
  const healthy = filtered.filter(d => getSignal(d).type === "healthy");

  const companyLines = filtered.map(d => {
    const sig = getSignal(d);
    return `${d.company} | Type: ${d.type} | Q3: $${d.q3.toLocaleString()} | Q4: $${d.q4.toLocaleString()} | Q1: $${d.q1.toLocaleString()} | Signal: ${sig.type} | Recent Deal: ${d.dealAmt > 0 ? '$'+d.dealAmt.toLocaleString() : 'none'} | Last Close: ${d.lastClose || 'none'} | Open Deals: ${d.openDeals}`;
  }).join("\n");

  return `You are analyzing quarterly invoice data for Neovolta, a solar energy storage company, to help their VP of Sales identify account risks and opportunities. The data covers Q3 2025, Q4 2025, and Q1 2026 (current quarter, still in progress ‚Äî we are in mid-February 2026).

Summary:
- Total accounts (over $1K threshold): ${filtered.length}
- Total Q3 2025: $${tQ3.toLocaleString()}
- Total Q4 2025: $${tQ4.toLocaleString()}  
- Total Q1 2026: $${tQ1.toLocaleString()} (quarter still in progress)
- At Risk (declining, no deal activity): ${atRisk.length} accounts
- Invoice Expected (declining but deal activity present): ${expected.length} accounts
- Healthy (stable/growing): ${healthy.length} accounts
- Distributors: ${filtered.filter(d=>d.type==='Distributor').length} | Installers: ${filtered.filter(d=>d.type==='Installer').length}

Company-level data:
${companyLines}

Provide exactly 5 insights as a JSON array. Each insight object must have:
- "icon": one of "risk", "opp", "trend", "watch", "info"  
- "text": the insight (use <strong> tags around company names and dollar amounts, 1-2 sentences max)

Focus on:
1. The single biggest revenue risk right now ‚Äî name the account and the dollar impact
2. Distributor vs installer channel patterns worth noting
3. Accounts with promising signals (recent deals, new revenue appearing)
4. A pattern or concentration risk the VP should be aware of
5. One specific, actionable next step

Be direct. Use actual company names and dollar figures. Don't hedge or be generic. Remember Q1 is mid-quarter so low Q1 numbers are expected ‚Äî focus on accounts with ZERO deal pipeline as the real concerns.

Respond with ONLY the JSON array, no markdown, no backticks, no other text.`;
}

async function fetchInsights(data) {
  STATE.insightsLoading = true;
  STATE.insightsError = null;
  STATE.insightsHTML = null;
  renderInsightsPanel();

  try {
    const response = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [{ role: "user", content: buildInsightsPrompt(data) }]
      })
    });

    if (!response.ok) {
      const errBody = await response.text();
      throw new Error(`API returned ${response.status}`);
    }

    const result = await response.json();
    const text = result.content.map(c => c.text || "").join("");
    
    const cleaned = text.replace(/```json|```/g, "").trim();
    const insights = JSON.parse(cleaned);

    const iconEmoji = { risk: "üî¥", opp: "üü¢", trend: "üìä", watch: "üü°", info: "üí°" };

    STATE.insightsHTML = `<ul class="insight-list">${insights.map(ins => `
      <li class="insight-item">
        <div class="insight-icon ${ins.icon}">${iconEmoji[ins.icon] || "üí°"}</div>
        <div class="insight-text">${ins.text}</div>
      </li>
    `).join("")}</ul>
    <button class="insights-refresh" onclick="refreshInsights()">‚Üª Regenerate insights</button>`;

  } catch (err) {
    console.error("Insights error:", err);
    STATE.insightsError = "Could not generate insights ‚Äî " + err.message;
  }

  STATE.insightsLoading = false;
  renderInsightsPanel();
}

function refreshInsights() {
  fetchInsights(STATE.data);
}

function renderInsightsPanel() {
  const body = document.getElementById("insights-body");
  if (!body) return;

  if (STATE.insightsLoading) {
    body.innerHTML = `<div class="insights-loading"><div class="spinner"></div>Analyzing ${STATE.data.filter(r=>r.q3+r.q4+r.q1>=1000).length} accounts with AI...</div>`;
  } else if (STATE.insightsError) {
    body.innerHTML = `<div class="insights-error">${STATE.insightsError}</div><button class="insights-refresh" onclick="refreshInsights()">‚Üª Try again</button>`;
  } else if (STATE.insightsHTML) {
    body.innerHTML = STATE.insightsHTML;
  }
}

function toggleInsights() {
  STATE.insightsOpen = !STATE.insightsOpen;
  const body = document.getElementById("insights-body");
  const toggle = document.getElementById("insights-toggle");
  if (body) body.className = STATE.insightsOpen ? "insights-body open" : "insights-body";
  if (toggle) toggle.className = STATE.insightsOpen ? "insights-toggle open" : "insights-toggle";
}

// ===== FILTERS & SORTING =====

function applyFilters() {
  let d = STATE.data.filter(r => r.q3 + r.q4 + r.q1 >= 1000);
  if (STATE.typeFilter === "distributor") d = d.filter(r => r.type === "Distributor");
  else if (STATE.typeFilter === "installer") d = d.filter(r => r.type === "Installer");
  if (STATE.filter === "declining") d = d.filter(r => getSignal(r).type !== "healthy");
  else if (STATE.filter === "healthy") d = d.filter(r => getSignal(r).type === "healthy");
  else if (STATE.filter === "danger") d = d.filter(r => getSignal(r).type === "danger");
  else if (STATE.filter === "expected") d = d.filter(r => getSignal(r).type === "expected");

  if (STATE.sortBy === "risk") {
    const order = {danger:0,expected:1,healthy:2};
    d.sort((a,b) => {
      const diff = order[getSignal(a).type] - order[getSignal(b).type];
      return diff !== 0 ? diff : (b.q3+b.q4+b.q1)-(a.q3+a.q4+a.q1);
    });
  } else if (STATE.sortBy === "revenue") {
    d.sort((a,b) => (b.q3+b.q4+b.q1)-(a.q3+a.q4+a.q1));
  } else if (STATE.sortBy === "trend") {
    d.sort((a,b) => (a.q1-a.q4)-(b.q1-b.q4));
  }
  STATE.filtered = d;
}

function badgeHTML(signal) {
  return `<span class="badge ${signal.type}"><span class="bdot" style="background:${signal.color}"></span>${signal.label}</span>`;
}

function miniBarHTML(d, maxVal) {
  const bars = [
    {key:"q3",label:"Q3",color:"var(--q3)"},
    {key:"q4",label:"Q4",color:"var(--q4)"},
    {key:"q1",label:"Q1",color:"var(--q1)"},
  ];
  return `<div class="mini-bars">${bars.map(b => {
    const val = d[b.key];
    const w = maxVal > 0 ? Math.max((val/maxVal)*100,0) : 0;
    return `<div class="mini-row">
      <span class="mini-label">${b.label}</span>
      <div class="mini-track"><div class="mini-fill" style="width:${w}%;background:${b.color};opacity:${val===0?0.15:0.85}"></div></div>
      <span class="mini-val" style="color:${val>0?'var(--text)':'var(--text-dim)'}">${val>0?fmt(val):'‚Äî'}</span>
    </div>`;
  }).join("")}</div>`;
}

function cardHTML(d, maxVal) {
  const signal = getSignal(d);
  const isSelected = STATE.selected === d.company;
  return `<div class="card${isSelected?' selected':''}" style="border-left-color:${signal.color};${isSelected?'border-color:'+signal.color+'66':''}" onclick="selectCompany('${d.company.replace(/'/g,"\\'")}')">
    <div class="card-header">
      <div style="max-width:55%">
        <div class="card-name">${d.company}</div>
        <div class="card-type${d.type==='Distributor'?' dist':''}">${d.type}</div>
      </div>
      ${badgeHTML(signal)}
    </div>
    ${miniBarHTML(d, maxVal)}
    <div class="card-footer">
      <span>Last deal: ${fmtDate(d.lastClose)}</span>
      ${d.dealAmt>0?`<span class="card-deal">Deal: ${fmt(d.dealAmt)}</span>`:''}
    </div>
  </div>`;
}

function detailHTML(d) {
  if (!d) return `<div class="detail empty">Click any company card to see details</div>`;
  const signal = getSignal(d);
  const total = d.q3+d.q4+d.q1;
  const maxQ = Math.max(d.q3,d.q4,d.q1);
  const q3q4 = d.q3>0 ? (((d.q4-d.q3)/d.q3)*100).toFixed(1) : d.q4>0?"NEW":"0";
  const q4q1 = d.q4>0 ? (((d.q1-d.q4)/d.q4)*100).toFixed(1) : d.q1>0?"NEW":"0";

  const quarters = [
    {label:"Q3 2025",val:d.q3,color:"var(--q3)"},
    {label:"Q4 2025",val:d.q4,color:"var(--q4)"},
    {label:"Q1 2026",val:d.q1,color:"var(--q1)"},
  ];

  function trendDisplay(pct) {
    if (pct==="NEW") return `<span style="color:var(--green)">‚òÖ NEW</span>`;
    if (pct==="0") return `<span style="color:var(--text-dim)">‚Äî</span>`;
    const n = Number(pct);
    const color = n>=0?"var(--green)":"var(--red)";
    return `<span style="color:${color}">${n>0?"‚Üë":"‚Üì"} ${pct}%</span>`;
  }

  return `<div class="detail" style="border-left:3px solid ${signal.color}">
    <div class="detail-header">
      <div>
        <div class="detail-name">${d.company}</div>
        <div class="detail-sub"><span class="dtype${d.type==='Distributor'?' dist':''}">${d.type}</span> ¬∑ Total invoiced: ${fmtFull(total)}</div>
      </div>
      ${badgeHTML(signal)}
    </div>
    <div class="detail-chart">
      ${quarters.map(q => `<div class="detail-bar-col"><div class="detail-bar-inner">
        <div class="detail-bar-val" style="color:${q.val>0?'var(--text)':'var(--text-dim)'}">${q.val>0?fmt(q.val):'$0'}</div>
        <div class="detail-bar" style="background:${q.color};height:${maxQ>0?Math.max((q.val/maxQ)*100,2):2}%;opacity:${q.val===0?0.15:0.85}"></div>
      </div></div>`).join("")}
    </div>
    <div class="detail-labels">${quarters.map(q=>`<span>${q.label}</span>`).join("")}</div>
    <div class="trend-row">
      <div class="trend-box"><div class="trend-label">Q3 ‚Üí Q4</div><div class="trend-val">${trendDisplay(q3q4)}</div></div>
      <div class="trend-box"><div class="trend-label">Q4 ‚Üí Q1</div><div class="trend-val">${trendDisplay(q4q1)}</div></div>
    </div>
    <div class="deal-box">
      <div class="deal-title">DEAL ACTIVITY</div>
      <div class="deal-row"><span>Last closed:</span> <strong>${fmtDate(d.lastClose)}</strong></div>
      ${d.dealAmt>0?`<div class="deal-row" style="margin-top:4px"><span>Amount:</span> <strong class="amt">${fmtFull(d.dealAmt)}</strong></div>`:''}
    </div>
  </div>`;
}

function totalChartHTML(data) {
  const tQ3 = data.reduce((s,d)=>s+d.q3,0);
  const tQ4 = data.reduce((s,d)=>s+d.q4,0);
  const tQ1 = data.reduce((s,d)=>s+d.q1,0);
  const max = Math.max(tQ3,tQ4,tQ1);
  const quarters = [
    {label:"Q3 2025",val:tQ3,color:"var(--q3)"},
    {label:"Q4 2025",val:tQ4,color:"var(--q4)"},
    {label:"Q1 2026",val:tQ1,color:"var(--q1)"},
  ];
  return `<div class="chart-box">
    <div class="chart-title">Total Revenue by Quarter</div>
    <div class="chart-bars">
      ${quarters.map(q=>`<div class="chart-bar-col"><div class="chart-bar-inner">
        <div class="chart-bar-val">${fmt(q.val)}</div>
        <div class="chart-bar" style="background:${q.color};height:${max>0?Math.max((q.val/max)*100,3):3}%;opacity:0.85"></div>
      </div></div>`).join("")}
    </div>
    <div class="chart-labels">${quarters.map(q=>`<span>${q.label}</span>`).join("")}</div>
  </div>`;
}

function render() {
  applyFilters();
  const d = STATE.filtered;
  const maxVal = Math.max(...d.map(r=>Math.max(r.q3,r.q4,r.q1)),1);
  const dangerCount = d.filter(r=>getSignal(r).type==="danger").length;
  const expectedCount = d.filter(r=>getSignal(r).type==="expected").length;
  const healthyCount = d.filter(r=>getSignal(r).type==="healthy").length;
  const selectedData = STATE.selected ? STATE.data.find(r=>r.company===STATE.selected) : null;

  function btnCls(key,val,isType) { return `btn${isType?' btn-sm':''}${key===val?(isType?' type-active':' active'):''}`; }

  document.getElementById("app").className = "";
  document.getElementById("app").innerHTML = `
    <div class="header">
      <div class="header-top">
        <span class="logo">Neovolta</span>
        <span class="date-badge"><span class="dot">‚óè</span>Last Updated: ${STATE.lastUpdated}</span>
      </div>
      <h1>Quarterly Invoice Trends</h1>
      <p class="subtitle">Q3 2025 ‚Üí Q4 2025 ‚Üí Q1 2026 ¬∑ Accounts under $1K excluded</p>
    </div>

    <div class="scorecards">
      <div class="scorecards-left">
        <div class="scorecard alert"><div class="sc-label">‚ö† At Risk</div><div class="sc-val">${dangerCount}</div><div class="sc-sub">No deal activity</div></div>
        <div class="scorecard amber"><div class="sc-label">‚è≥ Invoice Expected</div><div class="sc-val">${expectedCount}</div><div class="sc-sub">Deal closed recently</div></div>
        <div class="scorecard good"><div class="sc-label">‚úì Healthy</div><div class="sc-val">${healthyCount}</div><div class="sc-sub">Stable or growing</div></div>
        <div class="scorecard"><div class="sc-label">Total Accounts</div><div class="sc-val">${d.length}</div><div class="sc-sub">Over $1K threshold</div></div>
      </div>
      ${totalChartHTML(d)}
    </div>

    <div class="insights-card">
      <div class="insights-header" onclick="toggleInsights()">
        <div class="insights-title">
          <div class="icon">‚ú¶</div>
          <div>
            <h3>AI Insights</h3>
            <span class="powered">Powered by Claude</span>
          </div>
        </div>
        <span id="insights-toggle" class="insights-toggle${STATE.insightsOpen?' open':''}">‚ñæ</span>
      </div>
      <div id="insights-body" class="insights-body${STATE.insightsOpen?' open':''}">
        ${STATE.insightsHTML || (STATE.insightsLoading ? '<div class="insights-loading"><div class="spinner"></div>Analyzing accounts with AI...</div>' : STATE.insightsError ? `<div class="insights-error">${STATE.insightsError}</div>` : '')}
      </div>
    </div>

    <div class="filters-row">
      <div class="filter-group">
        <span class="filter-label">TYPE:</span>
        <button class="${btnCls(STATE.typeFilter,'all',true)}" onclick="setTypeFilter('all')">All</button>
        <button class="${btnCls(STATE.typeFilter,'distributor',true)}" onclick="setTypeFilter('distributor')">Distributors</button>
        <button class="${btnCls(STATE.typeFilter,'installer',true)}" onclick="setTypeFilter('installer')">Installers</button>
      </div>
    </div>
    <div class="filters-row" style="margin-bottom:16px">
      <div class="filter-group">
        <button class="${btnCls(STATE.filter,'all')}" onclick="setFilter('all')">All (${d.length})</button>
        <button class="${btnCls(STATE.filter,'danger')}" onclick="setFilter('danger')">‚ö† At Risk (${dangerCount})</button>
        <button class="${btnCls(STATE.filter,'expected')}" onclick="setFilter('expected')">‚è≥ Expected (${expectedCount})</button>
        <button class="${btnCls(STATE.filter,'healthy')}" onclick="setFilter('healthy')">‚úì Healthy (${healthyCount})</button>
      </div>
      <div class="filter-group">
        <span class="filter-label">SORT:</span>
        <button class="${btnCls(STATE.sortBy,'risk',false)} btn-sm" onclick="setSort('risk')">Risk Level</button>
        <button class="${btnCls(STATE.sortBy,'revenue',false)} btn-sm" onclick="setSort('revenue')">Revenue</button>
        <button class="${btnCls(STATE.sortBy,'trend',false)} btn-sm" onclick="setSort('trend')">Biggest Drop</button>
      </div>
    </div>

    <div class="main-grid">
      <div class="cards-grid">
        ${d.map(r=>cardHTML(r,maxVal)).join("")}
      </div>
      <div>${detailHTML(selectedData)}</div>
    </div>

    <div class="footer">
      Data from HubSpot ¬∑ Invoices synced since Jul 1, 2025 ¬∑ Prepared by <a href="https://pivotslc.com" target="_blank">Pivot</a>
    </div>
  `;
}

function selectCompany(name) {
  STATE.selected = STATE.selected === name ? null : name;
  render();
}
function setFilter(f) { STATE.filter = f; STATE.selected = null; render(); }
function setTypeFilter(f) { STATE.typeFilter = f; STATE.selected = null; render(); }
function setSort(s) { STATE.sortBy = s; render(); }

// Load data then generate insights
fetch(SHEET_URL)
  .then(r => r.text())
  .then(text => {
    const rows = parseCSV(text);
    STATE.data = parseSheetData(rows);
    STATE.lastUpdated = new Date().toLocaleDateString("en-US", {month:"short",day:"numeric",year:"numeric"});
    render();
    // Fire off AI insights after initial render so the dashboard appears immediately
    fetchInsights(STATE.data);
  })
  .catch(err => {
    document.getElementById("app").innerHTML = `
      <h2 style="color:var(--red)">Failed to load data</h2>
      <p>${err.message}</p>
    `;
  });
</script>
</body>
</html>
